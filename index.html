<html>
<head>
<title>Mandelbrot</title>
</head>
<script>
var canvas;
var ctx;
 
var maxY = 1.5, minY = -1.5, minX = -2.5, maxX = 2;
var max_iter = 1024, escape = 100;
var palette = [];

var numWorkers = 8;
var workers = [];
var rowData, nextRow = 0;

function createTask(row) 
{
    var task = 
	{
        row: row, width: rowData.width, minX: minX, maxX: maxX,
        i: maxY + (minY - maxY) * row / canvas.height, max_iter: max_iter, escape: escape
    };
    return task;
}

function drawRow(workerResults) 
{
    var values = workerResults.values;
    var pixelData = rowData.data;
    
	for (var i = 0; i < rowData.width; i++) 
	{
        if (values[i] < 0) pixelData[4*i] = pixelData[4*i+1] = pixelData[4*i+2] = 0;
		else 
		{
            var color = this.palette[values[i]];
            pixelData[4*i] = color[0];
            pixelData[4*i+1] = color[1];
            pixelData[4*i+2] = color[2];
        }
		
		pixelData[4*i+3] = 255;
    }
	
    ctx.putImageData(this.rowData, 0, workerResults.row);
}

function startWorkers() 
{
    nextRow = 0;
    for (var i = 0; i < numWorkers; i++) 
	{
        var worker = workers[i];
        if (worker.idle) 
		{
            var task = createTask(nextRow);
            worker.idle = false;
            worker.postMessage(task);
            nextRow++;
        }
    }
}

function zoom(x, y, zm)
{
	var width = maxX - minX;
	var height = minY - maxY;
	var centerX = minX + ((width * x) / canvas.width);
	var centerY = maxY + ((height * y) / canvas.height);
 
	minX = centerX - width/zm;
	maxX = centerX + width/zm;
	maxY = centerY - height/zm;
	minY = centerY + height/zm;
 
	startWorkers();
}

function changeNum(){ numWorkers=parseInt(document.getElementById("Combobox1").value);}

window.onload = function()
{
    canvas = document.getElementById("fractal");
    ctx = canvas.getContext("2d");
 
    var width = ((maxY - minY) * canvas.width / canvas.height);
    var r_mid = (maxX + minX) / 2;
    minX = r_mid - width/2;
    maxX = r_mid + width/2;
 
    rowData = ctx.createImageData(canvas.width, 1);

// на тея 2 реда нямам никаква представа какво се случва..... това са готините цветове	
    function magic(x) { x = ((x + 256) & 0x1ff) - 256; return (x<0 ? -x:x); }
    for (i = 0; i <= max_iter; i++) palette.push([magic(5*i), magic(7*i), magic(11*i)]);

	
    canvas.onclick = function(event) {zoom(event.clientX-180,event.clientY,8);};
 
    for (var i = 0; i < numWorkers; i++) 
    {
        var worker = new Worker("worker.js");
 
        worker.onmessage = function(event) 
	{
		var worker=event.target, workerResults=event.data;
			
		drawRow(workerResults);
    
		var row = nextRow++;
		if (row >= canvas.height) worker.idle = true;
		else 
		{
			var task = createTask(row);
			worker.idle = false;
			worker.postMessage(task);
		}
        }
 
        worker.idle = true;
        workers.push(worker);
    }
 
    document.getElementById("Combobox1").value="8";
	
    startWorkers();
}

</script>
<body>
<canvas id="fractal" style="position:absolute; left:180px;" width="1000" height="560"></canvas>
<span style="font-family:Arial; position:absolute; left:360px; top:600px;">Workers:</span>
<select id="Combobox1" onchange="changeNum()" style="position:absolute; left:430px; top:600px; width:50px;">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
</select>
<input type="submit" style="position:absolute; top:600px; left:560px; width:100px;" value="zoom Out" onclick="zoom(500,250,0.5)">
<input type="submit" style="position:absolute; top:600px; left:740px; width:100px;" value="zoom In" onclick="zoom(500,250,8)">
</body>
</html>
